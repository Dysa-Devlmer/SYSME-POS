version: '3.8'

# ======================================
# SYSME POS - Development Docker Compose
# Hot-reload enabled for rapid development
# ======================================
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# This file extends docker-compose.yml with development-specific settings

services:
  # Backend API - Development Overrides
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: dependencies
    command: npm run dev
    environment:
      - NODE_ENV=development
      - DEBUG=true
      - LOG_LEVEL=debug
      - LOG_SQL_QUERIES=true
      - LOG_API_REQUESTS=true
      - HOT_RELOAD=true
    volumes:
      # Mount source code for hot-reload
      - ./backend:/app
      - /app/node_modules
      # Mount logs for easy access
      - ./backend/logs:/app/logs
      - ./backend/backups:/app/backups
    ports:
      # Expose additional ports for debugging
      - "3000:3000"
      - "9229:9229"  # Node.js debugger port
    stdin_open: true
    tty: true

  # Frontend - Development Overrides
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: builder
    command: npm run dev -- --host 0.0.0.0
    environment:
      - VITE_ENV=development
      - VITE_API_URL=http://localhost:3000/api
      - VITE_WS_URL=ws://localhost:3000
    volumes:
      # Mount source code for hot-reload
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
      - ./vite.config.ts:/app/vite.config.ts
      - ./tsconfig.json:/app/tsconfig.json
      - /app/node_modules
    ports:
      - "5173:5173"
      - "24678:24678"  # Vite HMR port
    stdin_open: true
    tty: true

  # Redis - Development Configuration
  redis:
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes

  # ====================================
  # ADDITIONAL DEVELOPMENT SERVICES
  # ====================================

  # Mailhog - Email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: sysme-mailhog
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web UI
    networks:
      - sysme-network
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "2"

  # Database Admin (Optional - SQLite Browser)
  # Uncomment if using PostgreSQL instead of SQLite
  # adminer:
  #   image: adminer:latest
  #   container_name: sysme-adminer
  #   restart: unless-stopped
  #   ports:
  #     - "8080:8080"
  #   networks:
  #     - sysme-network
  #   environment:
  #     - ADMINER_DEFAULT_SERVER=postgres

# No additional volumes needed - using mounts from main compose file

networks:
  sysme-network:
    # Use existing network from docker-compose.yml
    external: false
